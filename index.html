<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberProfile - Mint Your Cyberpunk Identity</title>
    <meta property="fc:frame" content="vNext" />
    <meta property="fc:frame:image" content="https://your-domain.com/api/generate-preview" />
    <meta property="fc:frame:button:1" content="🔮 Transform My PFP" />
    <meta property="fc:frame:button:2" content="💎 Mint NFT" />
    <meta property="fc:frame:button:3" content="📊 Check Eligibility" />
    <meta property="fc:frame:post_url" content="https://your-domain.com/api/frame-action" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0033 50%, #000a1a 100%);
            color: #00ff9f;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 255, 159, 0.03) 0px,
                rgba(0, 255, 159, 0.03) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 1000;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            border: 2px solid #00ff9f;
            border-radius: 10px;
            background: rgba(0, 255, 159, 0.05);
            box-shadow: 0 0 30px rgba(0, 255, 159, 0.3);
            animation: pulse-border 2s ease-in-out infinite;
        }

        @keyframes pulse-border {
            0%, 100% { box-shadow: 0 0 30px rgba(0, 255, 159, 0.3); }
            50% { box-shadow: 0 0 50px rgba(0, 255, 159, 0.6); }
        }

        h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            text-shadow: 0 0 20px #00ff9f, 0 0 40px #00ff9f;
            letter-spacing: 4px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #ff00ff;
            text-shadow: 0 0 10px #ff00ff;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid #00ff9f;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 0 20px rgba(0, 255, 159, 0.2);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 40px rgba(0, 255, 159, 0.4);
        }

        .image-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            border: 3px solid #ff00ff;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
            background: #000;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .spinner {
            border: 4px solid rgba(0, 255, 159, 0.1);
            border-radius: 50%;
            border-top: 4px solid #00ff9f;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .button {
            width: 100%;
            padding: 1.2rem;
            margin: 0.5rem 0;
            font-size: 1.1rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background: linear-gradient(135deg, #00ff9f 0%, #00b8ff 100%);
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 0 20px rgba(0, 255, 159, 0.4);
        }

        .button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 255, 159, 0.6);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button.secondary {
            background: linear-gradient(135deg, #ff00ff 0%, #ff0080 100%);
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.4);
        }

        .button.secondary:hover {
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.6);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-box {
            background: rgba(0, 255, 159, 0.1);
            border: 1px solid #00ff9f;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #00ff9f;
            margin-bottom: 0.5rem;
            opacity: 0.7;
        }

        .stat-value {
            font-size: 1.5rem;
            color: #fff;
            font-weight: bold;
            text-shadow: 0 0 10px #00ff9f;
        }

        .eligibility-status {
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            margin-top: 1rem;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .eligible {
            background: rgba(0, 255, 159, 0.2);
            border: 2px solid #00ff9f;
            color: #00ff9f;
        }

        .not-eligible {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #ff0000;
            color: #ff0000;
        }

        .parameters-panel {
            background: rgba(255, 0, 255, 0.1);
            border: 2px solid #ff00ff;
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .parameter-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255, 0, 255, 0.3);
        }

        .parameter-row:last-child {
            border-bottom: none;
        }

        .parameter-label {
            color: #ff00ff;
        }

        .parameter-value {
            color: #fff;
            font-weight: bold;
        }

        .glitch {
            animation: glitch 3s infinite;
        }

        @keyframes glitch {
            0%, 90%, 100% { transform: translate(0); }
            92% { transform: translate(-2px, 2px); }
            94% { transform: translate(2px, -2px); }
            96% { transform: translate(-2px, -2px); }
            98% { transform: translate(2px, 2px); }
        }

        .nft-preview {
            position: relative;
            background: #000;
            border: 3px solid #00ff9f;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .nft-preview::before {
            content: 'NFT';
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff00ff;
            color: #000;
            padding: 0.3rem 0.8rem;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.8rem;
            z-index: 10;
        }

        .info-text {
            color: #00b8ff;
            font-size: 0.9rem;
            text-align: center;
            margin-top: 1rem;
            line-height: 1.6;
        }

        .connect-wallet-btn {
            background: linear-gradient(135deg, #ff00ff 0%, #00ff9f 100%);
        }
    </style>
</head>
<body>
    <div class="scanlines"></div>
    
    <div class="container">
        <div class="header glitch">
            <h1>⚡ CYBERPROFILE ⚡</h1>
            <p class="subtitle">Transform Your Identity. Mint Your Future.</p>
        </div>

        <div class="main-content">
            <!-- Original Profile -->
            <div class="card">
                <h2 style="margin-bottom: 1rem; color: #00ff9f;">📸 Original Profile</h2>
                <div class="image-container">
                    <img id="originalImage" src="https://via.placeholder.com/400/1a0033/00ff9f?text=Connect+Farcaster" alt="Original PFP">
                </div>
                <button class="button connect-wallet-btn" id="connectBtn">🔗 Connect Farcaster</button>
                <button class="button" id="transformBtn" disabled>🔮 Generate Cyberpunk PFP</button>
            </div>

            <!-- Transformed Profile -->
            <div class="card">
                <h2 style="margin-bottom: 1rem; color: #ff00ff;">🤖 Cyberpunk Transform</h2>
                <div class="nft-preview">
                    <div class="image-container">
                        <img id="transformedImage" src="https://via.placeholder.com/400/0a0a0a/ff00ff?text=Transform+to+Preview" alt="Transformed PFP">
                        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                            <div class="spinner"></div>
                            <p style="color: #00ff9f; margin-top: 1rem;">GENERATING...</p>
                        </div>
                    </div>
                </div>
                <button class="button secondary" id="mintBtn" disabled>💎 MINT NFT</button>
                <div id="eligibilityStatus"></div>
            </div>
        </div>

        <!-- User Stats -->
        <div class="card">
            <h2 style="margin-bottom: 1rem; color: #00ff9f;">📊 User Stats</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Farcaster ID</div>
                    <div class="stat-value" id="fidValue">---</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Account Type</div>
                    <div class="stat-value" id="accountType">---</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Minting Cost</div>
                    <div class="stat-value" id="mintCost">---</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Minted</div>
                    <div class="stat-value" id="totalMinted">---</div>
                </div>
            </div>
        </div>

        <!-- Current Parameters -->
        <div class="parameters-panel">
            <h2 style="margin-bottom: 1rem; color: #ff00ff;">⚙️ Current Minting Parameters</h2>
            <div class="parameter-row">
                <span class="parameter-label">FID Range (Eligible)</span>
                <span class="parameter-value" id="fidRange">Loading...</span>
            </div>
            <div class="parameter-row">
                <span class="parameter-label">Pro User Discount</span>
                <span class="parameter-value" id="proDiscount">Loading...</span>
            </div>
            <div class="parameter-row">
                <span class="parameter-label">Base Mint Price</span>
                <span class="parameter-value" id="baseMintPrice">Loading...</span>
            </div>
            <div class="parameter-row">
                <span class="parameter-label">Pro User Price</span>
                <span class="parameter-value" id="proMintPrice">Loading...</span>
            </div>
            <div class="parameter-row">
                <span class="parameter-label">Max Supply</span>
                <span class="parameter-value" id="maxSupply">Loading...</span>
            </div>
        </div>

        <p class="info-text">
            ⚡ Your profile picture becomes the DNA for a unique cyberpunk transformation powered by AI.<br>
            💎 Mint parameters are dynamically controlled to create exclusivity and fair access.<br>
            🔮 Early Farcaster users and Pro members get special benefits!
        </p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // Configuration
        const API_BASE = 'https://cyberprofile-production.up.railway.app/api';
        const CONTRACT_ADDRESS = 'YOUR_CONTRACT_ADDRESS';
        const CHAIN_ID = 8453; // Base chain

        // State
        let userFid = null;
        let userAddress = null;
        let isPro = false;
        let username = null;
        let displayName = null;
        let transformedImageUrl = null;
        let mintingParameters = null;

        // Contract ABI (simplified)
        const CONTRACT_ABI = [
            "function mint(address to, string memory tokenURI, uint256 fid) public payable",
            "function getMintPrice(uint256 fid, bool isPro) public view returns (uint256)",
            "function isEligible(uint256 fid) public view returns (bool)",
            "function mintingParams() public view returns (tuple(uint256 minFid, uint256 maxFid, uint256 baseMintPrice, uint256 proMintPrice, uint256 maxSupply, uint256 currentSupply))"
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            setupEventListeners();
            await loadMintingParameters();
        });

        function setupEventListeners() {
            document.getElementById('connectBtn').addEventListener('click', connectFarcaster);
            document.getElementById('transformBtn').addEventListener('click', transformProfile);
            document.getElementById('mintBtn').addEventListener('click', mintNFT);
        }

        async function loadMintingParameters() {
            try {
                const response = await fetch(`${API_BASE}/parameters`);
                mintingParameters = await response.json();
                updateParametersDisplay(mintingParameters);
            } catch (error) {
                console.error('Error loading parameters:', error);
            }
        }

        function updateParametersDisplay(params) {
            document.getElementById('fidRange').textContent = 
                `${params.minFid} - ${params.maxFid}`;
            document.getElementById('proDiscount').textContent = 
                `${params.proDiscountPercent}%`;
            document.getElementById('baseMintPrice').textContent = 
                `${params.baseMintPrice} ETH`;
            document.getElementById('proMintPrice').textContent = 
                `${params.proMintPrice} ETH`;
            document.getElementById('maxSupply').textContent = 
                `${params.currentSupply}/${params.maxSupply}`;
            
            document.getElementById('totalMinted').textContent = params.currentSupply;
        }

        async function connectFarcaster() {
            try {
                // Prompt user for their Farcaster ID
                const fidInput = prompt('Enter your Farcaster ID (FID):');
                
                if (!fidInput) {
                    return;
                }
                
                const fid = parseInt(fidInput);
                
                if (isNaN(fid) || fid < 1) {
                    alert('Please enter a valid FID number');
                    return;
                }
                
                // Fetch user data from backend
                const response = await fetch(`${API_BASE}/user/${fid}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch user data');
                }
                
                const userData = await response.json();
                
                userFid = userData.fid;
                isPro = userData.isPro;
                username = userData.username;
                displayName = userData.displayName;
                
                // Update UI
                document.getElementById('originalImage').src = userData.profileImage;
                document.getElementById('fidValue').textContent = userFid;
                document.getElementById('accountType').textContent = 
                    isPro ? '⭐ PRO' : '👤 FREE';
                
                // Calculate and show mint cost
                const mintPrice = userData.mintPrice;
                document.getElementById('mintCost').textContent = 
                    `${mintPrice} ETH`;
                
                // Check eligibility
                if (userData.isEligible) {
                    document.getElementById('eligibility').innerHTML = 
                        '<span style="color: #00ff9f;">✅ Eligible to mint</span>';
                } else {
                    document.getElementById('eligibility').innerHTML = 
                        '<span style="color: #ff00ff;">❌ Not eligible</span>';
                }
                
                // Enable transform button
                document.getElementById('transformBtn').disabled = false;
                document.getElementById('connectBtn').textContent = '✅ Connected';
                document.getElementById('connectBtn').disabled = true;
                
            } catch (error) {
                console.error('Connection error:', error);
                alert('Failed to connect. Please try again.');
            }
        }

        async function transformProfile() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const transformBtn = document.getElementById('transformBtn');
            
            try {
                loadingOverlay.style.display = 'flex';
                transformBtn.disabled = true;
                
                // Call AI transformation API
                const response = await fetch(`${API_BASE}/transform`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fid: userFid,
                        imageUrl: document.getElementById('originalImage').src
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Transformation failed');
                }
                
                const result = await response.json();
                transformedImageUrl = result.transformedUrl;
                
                // Update image
                document.getElementById('transformedImage').src = transformedImageUrl;
                
                // Enable mint button
                document.getElementById('mintBtn').disabled = false;
                
            } catch (error) {
                console.error('Transformation error:', error);
                alert('Transformation failed. Please try again.');
            } finally {
                loadingOverlay.style.display = 'none';
                transformBtn.disabled = false;
            }
        }

        async function checkEligibility(fid) {
            try {
                const response = await fetch(`${API_BASE}/check-eligibility/${fid}`);
                const result = await response.json();
                
                const statusDiv = document.getElementById('eligibilityStatus');
                
                if (result.isEligible) {
                    statusDiv.className = 'eligibility-status eligible';
                    statusDiv.textContent = '✅ ELIGIBLE TO MINT';
                } else {
                    statusDiv.className = 'eligibility-status not-eligible';
                    statusDiv.textContent = `❌ NOT ELIGIBLE - ${result.reason}`;
                }
            } catch (error) {
                console.error('Eligibility check error:', error);
            }
        }

        async function getMintPrice(fid, isPro) {
            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                return await contract.getMintPrice(fid, isPro);
            } catch (error) {
                console.error('Error getting mint price:', error);
                return ethers.utils.parseEther(isPro ? '0.001' : '0.002');
            }
        }

        async function mintNFT() {
            if (!transformedImageUrl) {
                alert('Please transform your profile first!');
                return;
            }
            
            try {
                if (!window.ethereum) {
                    alert('Please install MetaMask to mint!');
                    return;
                }
                
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                const signer = provider.getSigner();
                
                // Prepare mint (upload to IPFS and create metadata)
                const metadataResponse = await fetch(`${API_BASE}/prepare-mint`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        imageUrl: transformedImageUrl,
                        fid: userFid,
                        username: username,
                        displayName: displayName
                    })
                });
                
                const { tokenURI } = await metadataResponse.json();
                
                // Get contract
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                // Get mint price
                const mintPrice = await contract.getMintPrice(userFid, isPro);
                
                // Mint!
                const tx = await contract.mint(userAddress, tokenURI, userFid, {
                    value: mintPrice
                });
                
                document.getElementById('mintBtn').textContent = '⏳ Minting...';
                document.getElementById('mintBtn').disabled = true;
                
                await tx.wait();
                
                alert('🎉 Successfully minted your CyberProfile NFT!');
                document.getElementById('mintBtn').textContent = '✅ MINTED!';
                
                // Refresh stats
                await loadMintingParameters();
                
            } catch (error) {
                console.error('Minting error:', error);
                alert('Minting failed: ' + error.message);
                document.getElementById('mintBtn').textContent = '💎 MINT NFT';
                document.getElementById('mintBtn').disabled = false;
            }
        }

        // Auto-refresh parameters every 30 seconds
        setInterval(loadMintingParameters, 30000);
    </script>
</body>
</html>
